from aiogram import Router, F
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from states.driver_state import DriverForm
from db import deactivate_driver, activate_driver
from asyncpg import Pool

router = Router()

# ğŸŒ Ğ¯Ğ·Ñ‹ĞºĞ¸
translations = {
    "ru": "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹",
    "en": "ğŸ‡¬ğŸ‡§ English",
    "uz": "ğŸ‡ºğŸ‡¿ OÊ»zbek",
    "uk": "ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°",
    "hi": "ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€",
    "pl": "ğŸ‡µğŸ‡± Polski"
}

language_keyboard = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text=lang)] for lang in translations.values()],
    resize_keyboard=True,
    one_time_keyboard=True
)

main_menu_keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="ğŸ“ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ")],
        [KeyboardButton(text="ğŸ“¦ Ğ”Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹")],
        [KeyboardButton(text="ğŸŒ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº")],
        [KeyboardButton(text="ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°")],
        [KeyboardButton(text="ğŸš« Ğ’Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ")],
        [KeyboardButton(text="âœ… Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ (Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾)")]
    ],
    resize_keyboard=True
)

user_languages = {}

# ğŸ”˜ /start
@router.message(Command("start"))
async def handle_start(message: Message, state: FSMContext):
    print(f"ğŸ‘‰ /start Ğ¾Ñ‚ {message.from_user.id}")
    await state.clear()
    await message.answer("ğŸŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:", reply_markup=language_keyboard)

# ğŸŒ Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ°
@router.message(F.text.in_(translations.values()))
async def select_language(message: Message):
    lang_code = next((code for code, label in translations.items() if label == message.text), None)
    if lang_code:
        user_languages[message.from_user.id] = lang_code
        await message.answer("âœ… Ğ¯Ğ·Ñ‹Ğº ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=main_menu_keyboard)
    else:
        await message.answer("âŒ ĞĞµĞ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğ¹ ÑĞ·Ñ‹Ğº.")

# ğŸ“ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ
@router.message(F.text == "ğŸ“ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ")
async def start_fill_form_button(message: Message, state: FSMContext):
    await state.set_state(DriverForm.full_name)
    await message.answer("ğŸ“ ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾! ĞĞ°Ñ‡Ğ½Ñ‘Ğ¼ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ°Ğ½ĞºĞµÑ‚Ñ‹. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ *Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ* (Ğ¤Ğ˜Ğ):", parse_mode="Markdown")

# ğŸŒ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº
@router.message(F.text == "ğŸŒ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº")
async def change_language_button(message: Message):
    await message.answer("ğŸŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:", reply_markup=language_keyboard)

# ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°)
@router.message(F.text == "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°")
async def stats_button(message: Message):
    await message.answer("ğŸ“Š Ğ Ğ°Ğ·Ğ´ĞµĞ» ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ ÑĞºĞ¾Ñ€Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½.")

# ğŸ“¦ Ğ”Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹
@router.message(F.text == "ğŸ“¦ Ğ”Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹")
async def for_companies_button(message: Message):
    await message.answer("ğŸ’¼ Ğ Ğ°Ğ·Ğ´ĞµĞ» Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ Ğ² Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ. Ğ¡ĞºĞ¾Ñ€Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½!")

# ğŸš« Ğ’Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ
@router.message(F.text == "ğŸš« Ğ’Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ")
async def deactivate_profile(message: Message):
    app = message.bot._ctx.get("application")
    if not app or "db" not in app:
        await message.answer("âŒ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°.")
        return

    pool: Pool = app["db"]
    driver_id = message.from_user.id

    async with pool.acquire() as conn:
        await deactivate_driver(conn, driver_id)

    await message.answer("ğŸ›‘ Ğ’Ğ°ÑˆĞ° Ğ°Ğ½ĞºĞµÑ‚Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°.")

# âœ… Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ (Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾)
@router.message(F.text == "âœ… Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°Ğ½ĞºĞµÑ‚Ñƒ (Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾)")
async def activate_profile(message: Message):
    app = message.bot._ctx.get("application")
    if not app or "db" not in app:
        await message.answer("âŒ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°.")
        return

    pool: Pool = app["db"]
    driver_id = message.from_user.id

    # â— ĞŸĞ¾Ğ·Ğ¶Ğµ ÑÑĞ´Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹
    async with pool.acquire() as conn:
        await activate_driver(conn, driver_id)

    await message.answer("âœ… Ğ’Ğ°ÑˆĞ° Ğ°Ğ½ĞºĞµÑ‚Ğ° ÑĞ½Ğ¾Ğ²Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹.")
