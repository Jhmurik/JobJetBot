from aiohttp import web
from db import activate_driver, activate_manager, save_payment
import hmac
import hashlib
import os
import json

CRYPTOMUS_SECRET = os.getenv("CRYPTOMUS_SECRET")

# âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¾Ñ‚ Cryptomus
def verify_signature(body: bytes, signature: str) -> bool:
    computed = hmac.new(CRYPTOMUS_SECRET.encode(), body, hashlib.sha256).hexdigest()
    return hmac.compare_digest(computed, signature)

# ğŸ“¥ Webhook Ğ¾Ñ‚ Cryptomus
async def cryptomus_webhook(request: web.Request) -> web.Response:
    try:
        body = await request.read()
        signature = request.headers.get("sign")

        if not signature or not verify_signature(body, signature):
            return web.Response(status=401, text="âŒ Invalid signature")

        data = json.loads(body)
        status = data.get("status")
        user_id_raw = data.get("order_id")

        try:
            user_id = int(user_id_raw)
        except ValueError:
            return web.Response(status=400, text="âŒ Invalid user_id")

        if status == "paid":
            # ğŸ”„ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€
            role = data.get("custom", {}).get("role") or data.get("custom_fields", {}).get("role") or "driver"

            app = request.app
            pool = app["db"]

            async with pool.acquire() as conn:
                if role == "driver":
                    await activate_driver(conn, user_id)
                elif role == "manager":
                    await activate_manager(conn, user_id)

                # ğŸ’³ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶
                await save_payment(pool, {
                    "user_id": user_id,
                    "role": role,
                    "amount": data.get("amount"),
                    "currency": data.get("currency"),
                    "payment_method": "cryptomus",
                    "payment_type": "premium",
                    "description": "ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Webhook"
                })

            return web.Response(status=200, text="âœ… Payment processed")

        return web.Response(status=200, text="ğŸ• Payment not confirmed")

    except Exception as e:
        print(f"Webhook error: {e}")
        return web.Response(status=500, text="âŒ Server error")
